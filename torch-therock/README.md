# PyTorch w/ FA for gfx1151

After a few not-so-successful approaches, this one works:
- Use ROCm/TheROCK ROCm nightly - you can use `00-setup-env.sh` to create a "therock" mamba/conda env if you use conda for setup. If you are managing your own env just skip to the 01 script. 
- Build the pinned aotriton that TheRock PyTorch build script uses to build aotriton w/ `01-build-aotriton.sh`
- Build PyTorch leveraging our own aotriton and some extra patches we apply to the TheRock PyTorch build: `02-build-pytorch-with-aotriton-gfx1151.sh`
- Manually install the `.whl` files

## Quick Start

Optionally set up a fresh conda/mamba environment (or reuse your own):

```
# defaults to using `therock` env
./00-setup-env.sh [MYENV]
```

Run the builds from the Python environment you want to target:

```
# inherits PYTHON_EXE if you need to point at a specific interpreter
./01-build-aotriton.sh
./02-build-pytorch-with-aotriton-gfx1151.sh
```

Both scripts assume ROCm-enabled PyTorch is already installed in that interpreter; the setup script above provisions a default `therock` environment if you want a ready-made option.


## Results

10-30X faster backward and forward passes for attention that w/o aotriton FA.

Custom PyTorch (aotriton FA):
```
🐟 ❯ python 05-attention-bench.py
╔═════════════════════════════════════════════════════════════════════════════════════════╗
║                                  AOTriton Status Check                                  ║
╚═════════════════════════════════════════════════════════════════════════════════════════╝
PyTorch version: 2.9.0a0+rocmsdk20250830
CUDA available: True
ROCm version: 7.1.25344-b46750915f
TORCH_ROCM_AOTRITON_ENABLE_EXPERIMENTAL: 1
pyaotriton imported successfully
torch.ops.aotriton is available

╔═════════════════════════════════════════════════════════════════════════════════════════╗
║                           Testing Tiny: B=1, H=1, S=128, D=64                           ║
╚═════════════════════════════════════════════════════════════════════════════════════════╝
Estimated memory per QKV tensor: 0.00 GB
Total QKV memory: 0.00 GB
+--------------+----------------+-------------------+----------------+-------------------+
| Operation    |   FW Time (ms) |   FW FLOPS (TF/s) |   BW Time (ms) |   BW FLOPS (TF/s) |
+==============+================+===================+================+===================+
| Causal FA2   |         0.0594 |              0.04 |         0.1091 |              0.05 |
+--------------+----------------+-------------------+----------------+-------------------+
| Regular SDPA |         0.0464 |              0.05 |         0.1021 |              0.05 |
+--------------+----------------+-------------------+----------------+-------------------+

╔═════════════════════════════════════════════════════════════════════════════════════════╗
║                           Testing Small: B=2, H=4, S=512, D=64                          ║
╚═════════════════════════════════════════════════════════════════════════════════════════╝
Estimated memory per QKV tensor: 0.00 GB
Total QKV memory: 0.00 GB
+--------------+----------------+-------------------+----------------+-------------------+
| Operation    |   FW Time (ms) |   FW FLOPS (TF/s) |   BW Time (ms) |   BW FLOPS (TF/s) |
+==============+================+===================+================+===================+
| Causal FA2   |         0.1446 |              1.86 |         0.3355 |              2    |
+--------------+----------------+-------------------+----------------+-------------------+
| Regular SDPA |         0.092  |              2.92 |         0.3264 |              2.06 |
+--------------+----------------+-------------------+----------------+-------------------+

╔═════════════════════════════════════════════════════════════════════════════════════════╗
║                          Testing Medium: B=4, H=8, S=1024, D=64                         ║
╚═════════════════════════════════════════════════════════════════════════════════════════╝
Estimated memory per QKV tensor: 0.00 GB
Total QKV memory: 0.01 GB
+--------------+----------------+-------------------+----------------+-------------------+
| Operation    |   FW Time (ms) |   FW FLOPS (TF/s) |   BW Time (ms) |   BW FLOPS (TF/s) |
+==============+================+===================+================+===================+
| Causal FA2   |         0.9977 |               4.3 |         1.3278 |              8.09 |
+--------------+----------------+-------------------+----------------+-------------------+
| Regular SDPA |         0.6414 |               6.7 |         2.1933 |              4.9  |
+--------------+----------------+-------------------+----------------+-------------------+

╔═════════════════════════════════════════════════════════════════════════════════════════╗
║                          Testing Large: B=8, H=16, S=2048, D=64                         ║
╚═════════════════════════════════════════════════════════════════════════════════════════╝
Estimated memory per QKV tensor: 0.03 GB
Total QKV memory: 0.09 GB
+--------------+----------------+-------------------+----------------+-------------------+
| Operation    |   FW Time (ms) |   FW FLOPS (TF/s) |   BW Time (ms) |   BW FLOPS (TF/s) |
+==============+================+===================+================+===================+
| Causal FA2   |        10.6106 |              6.48 |        17.9762 |              9.56 |
+--------------+----------------+-------------------+----------------+-------------------+
| Regular SDPA |         9.5102 |              7.23 |        27.9019 |              6.16 |
+--------------+----------------+-------------------+----------------+-------------------+

╔═════════════════════════════════════════════════════════════════════════════════════════╗
║                         Testing XLarge: B=16, H=16, S=4096, D=64                        ║
╚═════════════════════════════════════════════════════════════════════════════════════════╝
Estimated memory per QKV tensor: 0.12 GB
Total QKV memory: 0.38 GB
+--------------+----------------+-------------------+----------------+-------------------+
| Operation    |   FW Time (ms) |   FW FLOPS (TF/s) |   BW Time (ms) |   BW FLOPS (TF/s) |
+==============+================+===================+================+===================+
| Causal FA2   |        68.5042 |              8.03 |        115.386 |             11.91 |
+--------------+----------------+-------------------+----------------+-------------------+
| Regular SDPA |        75.1694 |              7.31 |        279.074 |              4.92 |
+--------------+----------------+-------------------+----------------+-------------------+

╔═════════════════════════════════════════════════════════════════════════════════════════╗
║                                         Summary                                         ║
╚═════════════════════════════════════════════════════════════════════════════════════════╝
Tiny:
  Causal FA2: 0.0594 ms
  Regular SDPA: 0.0464 ms
Small:
  Causal FA2: 0.1446 ms
  Regular SDPA: 0.0920 ms
Medium:
  Causal FA2: 0.9977 ms
  Regular SDPA: 0.6414 ms
Large:
  Causal FA2: 10.6106 ms
  Regular SDPA: 9.5102 ms
XLarge:
  Causal FA2: 68.5042 ms
  Regular SDPA: 75.1694 ms
╔═════════════════════════════════════════════════════════════════════════════════════════╗
║                              Testing with different dtypes                              ║
╚═════════════════════════════════════════════════════════════════════════════════════════╝

Testing with torch.float16
Success with torch.float16

Testing with torch.bfloat16
Success with torch.bfloat16
```



TheRock PyTorch (no FA):
```
🐟 ❯ python 05-attention-bench.py
╔═════════════════════════════════════════════════════════════════════════════════════════╗
║                                  AOTriton Status Check                                  ║
╚═════════════════════════════════════════════════════════════════════════════════════════╝
PyTorch version: 2.7.1+rocm7.0.0rc20250828
CUDA available: True
ROCm version: 7.1.25344-b46750915f
TORCH_ROCM_AOTRITON_ENABLE_EXPERIMENTAL: 1
pyaotriton imported successfully
torch.ops.aotriton is available

╔═════════════════════════════════════════════════════════════════════════════════════════╗
║                           Testing Tiny: B=1, H=1, S=128, D=64                           ║
╚═════════════════════════════════════════════════════════════════════════════════════════╝
Estimated memory per QKV tensor: 0.00 GB
Total QKV memory: 0.00 GB
+--------------+----------------+-------------------+----------------+-------------------+
| Operation    |   FW Time (ms) |   FW FLOPS (TF/s) |   BW Time (ms) |   BW FLOPS (TF/s) |
+==============+================+===================+================+===================+
| Causal FA2   |         0.2669 |              0.01 |         0.3555 |              0.01 |
+--------------+----------------+-------------------+----------------+-------------------+
| Regular SDPA |         0.1986 |              0.01 |         0.2867 |              0.02 |
+--------------+----------------+-------------------+----------------+-------------------+

╔═════════════════════════════════════════════════════════════════════════════════════════╗
║                           Testing Small: B=2, H=4, S=512, D=64                          ║
╚═════════════════════════════════════════════════════════════════════════════════════════╝
Estimated memory per QKV tensor: 0.00 GB
Total QKV memory: 0.00 GB
+--------------+----------------+-------------------+----------------+-------------------+
| Operation    |   FW Time (ms) |   FW FLOPS (TF/s) |   BW Time (ms) |   BW FLOPS (TF/s) |
+==============+================+===================+================+===================+
| Causal FA2   |         0.6901 |              0.39 |         0.8514 |              0.79 |
+--------------+----------------+-------------------+----------------+-------------------+
| Regular SDPA |         0.5916 |              0.45 |         0.9075 |              0.74 |
+--------------+----------------+-------------------+----------------+-------------------+

╔═════════════════════════════════════════════════════════════════════════════════════════╗
║                          Testing Medium: B=4, H=8, S=1024, D=64                         ║
╚═════════════════════════════════════════════════════════════════════════════════════════╝
Estimated memory per QKV tensor: 0.00 GB
Total QKV memory: 0.01 GB
+--------------+----------------+-------------------+----------------+-------------------+
| Operation    |   FW Time (ms) |   FW FLOPS (TF/s) |   BW Time (ms) |   BW FLOPS (TF/s) |
+==============+================+===================+================+===================+
| Causal FA2   |        15.8525 |              0.27 |        22.3523 |              0.48 |
+--------------+----------------+-------------------+----------------+-------------------+
| Regular SDPA |        17.3547 |              0.25 |        18.7599 |              0.57 |
+--------------+----------------+-------------------+----------------+-------------------+

╔═════════════════════════════════════════════════════════════════════════════════════════╗
║                          Testing Large: B=8, H=16, S=2048, D=64                         ║
╚═════════════════════════════════════════════════════════════════════════════════════════╝
Estimated memory per QKV tensor: 0.03 GB
Total QKV memory: 0.09 GB
+--------------+----------------+-------------------+----------------+-------------------+
| Operation    |   FW Time (ms) |   FW FLOPS (TF/s) |   BW Time (ms) |   BW FLOPS (TF/s) |
+==============+================+===================+================+===================+
| Causal FA2   |        197.754 |              0.35 |        214.279 |              0.8  |
+--------------+----------------+-------------------+----------------+-------------------+
| Regular SDPA |        170.222 |              0.4  |        223.805 |              0.77 |
+--------------+----------------+-------------------+----------------+-------------------+

╔═════════════════════════════════════════════════════════════════════════════════════════╗
║                         Testing XLarge: B=16, H=16, S=4096, D=64                        ║
╚═════════════════════════════════════════════════════════════════════════════════════════╝
Estimated memory per QKV tensor: 0.12 GB
Total QKV memory: 0.38 GB
+--------------+----------------+-------------------+----------------+-------------------+
| Operation    |   FW Time (ms) |   FW FLOPS (TF/s) |   BW Time (ms) |   BW FLOPS (TF/s) |
+==============+================+===================+================+===================+
| Causal FA2   |        1950.32 |              0.28 |        2339.34 |              0.59 |
+--------------+----------------+-------------------+----------------+-------------------+
| Regular SDPA |        1498.6  |              0.37 |        2351.16 |              0.58 |
+--------------+----------------+-------------------+----------------+-------------------+

╔═════════════════════════════════════════════════════════════════════════════════════════╗
║                                         Summary                                         ║
╚═════════════════════════════════════════════════════════════════════════════════════════╝
Tiny:
  Causal FA2: 0.2669 ms
  Regular SDPA: 0.1986 ms
Small:
  Causal FA2: 0.6901 ms
  Regular SDPA: 0.5916 ms
Medium:
  Causal FA2: 15.8525 ms
  Regular SDPA: 17.3547 ms
Large:
  Causal FA2: 197.7539 ms
  Regular SDPA: 170.2224 ms
XLarge:
  Causal FA2: 1950.3215 ms
  Regular SDPA: 1498.6016 ms
╔═════════════════════════════════════════════════════════════════════════════════════════╗
║                              Testing with different dtypes                              ║
╚═════════════════════════════════════════════════════════════════════════════════════════╝

Testing with torch.float16
Success with torch.float16

Testing with torch.bfloat16
Success with torch.bfloat16
```
